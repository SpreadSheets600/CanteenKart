{% extends 'base.html' %} {% block title %}Token Scanner - CanteenKart{% endblock %} {% block content %}
<h1>Token / QR Scanner</h1>

<noscript>
	<p>Your browser has JavaScript disabled. Please enter token manually.</p>
	<style>
		#qr-enhanced {
			display: none;
		}
	</style>
</noscript>

<div id="qr-enhanced" style="margin-bottom: 12px">
	<video id="preview" playsinline style="width: 320px; height: auto; background: #000; display: none"></video>
	<canvas id="qr-canvas" style="display: none"></canvas>
	<div style="margin-top: 8px">
		<button id="startBtn" type="button">Start Camera</button>
		<button id="stopBtn" type="button" disabled>Stop</button>
		<span id="scanStatus" style="margin-left: 8px; font-size: 0.9em; color: #555"></span>
	</div>
	<div id="qrError" style="color: #c00; font-size: 0.9em; margin-top: 6px"></div>
</div>

<form id="tokenForm" method="post">
	<input id="tokenInput" type="text" name="token" placeholder="Enter token code" />
	<button type="submit">Mark Collected</button>
	<div style="font-size: 0.9em; color: #666; margin-top: 4px">Tip: Use the camera to auto-fill the token.</div>
	<div style="margin-top: 8px">
		<a href="{{ url_for('owner_orders.list_orders') }}">Back to Orders</a>
	</div>
</form>

<!-- Progressive enhancement: jsQR for client-side decoding -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
	(function () {
		const video = document.getElementById("preview");
		const canvas = document.getElementById("qr-canvas");
		const ctx = canvas.getContext("2d");
		const startBtn = document.getElementById("startBtn");
		const stopBtn = document.getElementById("stopBtn");
		const statusEl = document.getElementById("scanStatus");
		const errorEl = document.getElementById("qrError");
		const tokenInput = document.getElementById("tokenInput");
		const form = document.getElementById("tokenForm");

		let stream = null;
		let scanning = false;

		function supported() {
			return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.jsQR);
		}

		function setStatus(text) {
			statusEl.textContent = text || "";
		}
		function setError(text) {
			errorEl.textContent = text || "";
		}

		async function start() {
			if (!supported()) {
				setError("Camera or QR decoding not supported. Use manual entry.");
				return;
			}
			setError("");
			try {
				stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio: false });
				video.srcObject = stream;
				await video.play();
				video.style.display = "block";
				scanning = true;
				startBtn.disabled = true;
				stopBtn.disabled = false;
				setStatus("Scanning...");
				requestAnimationFrame(tick);
			} catch (err) {
				setError("Could not access camera. " + (err && err.message ? err.message : ""));
			}
		}

		function stop() {
			scanning = false;
			if (stream) {
				stream.getTracks().forEach((t) => t.stop());
				stream = null;
			}
			video.srcObject = null;
			video.style.display = "none";
			startBtn.disabled = false;
			stopBtn.disabled = true;
			setStatus("");
		}

		function tick() {
			if (!scanning) return;
			if (video.readyState === video.HAVE_ENOUGH_DATA) {
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
				if (code && code.data) {
					let token = "";
					try {
						const parsed = JSON.parse(code.data);
						token = parsed.token || parsed.order_token || "";
					} catch {
						token = String(code.data || "").trim();
					}
					if (token) {
						tokenInput.value = token;
						stop();
						form.submit();
						return;
					}
				}
			}
			requestAnimationFrame(tick);
		}

		startBtn.addEventListener("click", start);
		stopBtn.addEventListener("click", stop);

		if (!supported()) {
			setError("Camera/QR not supported in this browser or context.");
		} else {
			setStatus("Ready to scan");
		}
	})();
</script>
{% endblock %}
