{% extends 'base.html' %}
{% block title %}Owner Orders - CanteenKart{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Active Orders</h1>

<form method="get" class="flex flex-wrap items-end gap-2 mb-4">
  <label class="form-control w-40">
    <div class="label"><span class="label-text">Filter by status</span></div>
    <select class="select select-bordered select-sm" name="status">
      <option value="" {{ 'selected' if (request.args.get('status') or '') == '' else '' }}>All</option>
      <option value="pending" {{ 'selected' if request.args.get('status')=='pending' else '' }}>Pending</option>
      <option value="preparing" {{ 'selected' if request.args.get('status')=='preparing' else '' }}>Preparing</option>
      <option value="ready" {{ 'selected' if request.args.get('status')=='ready' else '' }}>Ready</option>
    </select>
  </label>
  <button type="submit" class="btn btn-sm">Apply</button>
  <span class="flex-1"></span>
  <a class="btn btn-ghost btn-sm" href="{{ url_for('owners.scanner') }}">Open Scanner</a>
  <a class="btn btn-ghost btn-sm" href="{{ url_for('owners.stock_page') }}">Stock</a>
  <a class="btn btn-ghost btn-sm" href="{{ url_for('owners.owner_dashboard') }}">Dashboard</a>
</form>

<div class="card bg-base-200 shadow">
  <div class="card-body">
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead><tr><th>ID</th><th>Token</th><th>User</th><th>Pickup</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>
        {% for order in orders %}
          <tr>
            <td>{{ order.order_id }}</td>
            <td>{{ order.token_code }}</td>
            <td>{{ order.user.name if order.user else order.user_id }}</td>
            <td>{{ order.pickup_slot or 'â€”' }}</td>
            <td id="status-{{ order.order_id }}">
              <span class="badge {{ 'badge-warning' if order.status in ['pending','preparing'] else ('badge-success' if order.status in ['ready','completed'] else '') }}">{{ order.status }}</span>
            </td>
            <td>
              <form action="{{ url_for('owner_orders.update_status', order_id=order.order_id) }}" method="post" class="flex items-center gap-2">
                <select class="select select-bordered select-xs" name="status">
                  <option value="pending" {% if order.status=='pending' %}selected{% endif %}>pending</option>
                  <option value="preparing" {% if order.status=='preparing' %}selected{% endif %}>preparing</option>
                  <option value="ready" {% if order.status=='ready' %}selected{% endif %}>ready</option>
                  <option value="completed" {% if order.status=='completed' %}selected{% endif %}>completed</option>
                </select>
                <button type="submit" class="btn btn-sm">Set</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if config.ENABLE_SOCKETIO %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  if (typeof io === 'undefined') {
    var s = document.createElement('script');
    s.src = '/socket.io/socket.io.js';
    document.head.appendChild(s);
  }
</script>
<script>
  const socket = io();
  socket.on('connect', () => console.log('socket connected'));
  socket.on('new_order', (data) => { console.log('new_order', data); location.reload(); });
  socket.on('order_update', (data) => {
    const container = document.getElementById('status-' + data.order_id);
    if (container) {
      container.innerHTML = `<span class="badge ${['ready','completed'].includes(data.status) ? 'badge-success' : (['pending','preparing'].includes(data.status) ? 'badge-warning' : '')}">${data.status}</span>`;
    }
  });
</script>
{% endif %}

{% endblock %}
