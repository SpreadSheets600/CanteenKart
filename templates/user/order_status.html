{% extends 'base.html' %} {% block title %}Order Status - CanteenKart{% endblock %} {% block content %}
<div id="order-data" data-order-id="{{ order.order_id }}" class="hidden"></div>

<div class="grid md:grid-cols-3 gap-4">
	<div class="md:col-span-2">
		<div class="card bg-base-200 shadow">
			<div class="card-body">
				<div class="flex items-center justify-between">
					<h1 class="card-title">Order #{{ order.order_id }}</h1>
					<div id="status" class="badge badge-lg {{ 'badge-warning' if order.status in ['pending','preparing'] else ('badge-success' if order.status in ['ready','completed'] else 'badge-ghost') }}">{{ order.status }}</div>
				</div>
				<div class="flex items-center gap-2">
					<span class="opacity-80">Token:</span>
					<code id="token" class="px-2 py-1 rounded bg-base-300">{{ order.token_code }}</code>
					<button type="button" class="btn btn-ghost btn-xs" onclick="navigator.clipboard.writeText('{{ order.token_code }}')">Copy</button>
				</div>
				<div class="mt-4 text-sm opacity-70">You'll be notified on this page when your order status changes.</div>
				<div class="mt-2"><a class="link" href="{{ url_for('users.orders_history') }}">View all my orders</a></div>
			</div>
		</div>
	</div>
	<div>
		<div class="card bg-base-200 shadow">
			<div class="card-body items-center text-center">
				<img class="rounded" src="{{ url_for('cart.order_status_qr', order_id=order.order_id) }}" alt="Order QR" width="200" height="200" />
				<div class="text-xs opacity-70">Scan at counter to retrieve your order</div>
				<a class="btn btn-sm mt-2" download href="{{ url_for('cart.order_status_qr', order_id=order.order_id) }}">Download QR</a>
			</div>
		</div>
	</div>
</div>

{% if config.ENABLE_SOCKETIO %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
	if (typeof io === "undefined") {
		var s = document.createElement("script");
		s.src = "/socket.io/socket.io.js";
		document.head.appendChild(s);
	}
</script>
<script>
	const socket = io();
	socket.on("connect", () => console.log("socket connected"));
	const THIS_ORDER_ID = Number(document.getElementById("order-data").dataset.orderId);
	socket.on("order_update", (data) => {
		if (data && data.order_id === THIS_ORDER_ID) {
			const el = document.getElementById("status");
			el.innerText = data.status;
			el.className = "badge badge-lg " + (["ready", "completed"].includes(data.status) ? "badge-success" : ["pending", "preparing"].includes(data.status) ? "badge-warning" : "badge-ghost");
		}
	});
</script>
{% endif %} {% endblock %}
